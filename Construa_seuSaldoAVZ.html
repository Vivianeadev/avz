import React, { useEffect, useMemo, useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Progress } from "@/components/ui/progress";
import { Coins, Wallet, CircleDollarSign, Gift, Trophy, ShieldCheck, MousePointer2, Repeat, Play, Pause, Sparkles, TrendingUp, Banknote, Rocket } from "lucide-react";

// —— helpers ——
const BRL = (n: number) => n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
const pad = (n: number) => String(n).padStart(2, "0");

// —— types ——
type Coin = {
  code: string;
  name: string;
  symbol: string; // emoji/single char
  color: string; // tailwind brand color key
};

const COINS: Coin[] = [
  { code: "BTC", name: "Bitcoin", symbol: "₿", color: "from-amber-400 to-yellow-300" },
  { code: "ETH", name: "Ethereum", symbol: "Ξ", color: "from-zinc-600 to-zinc-400" },
  { code: "DOGE", name: "Dogecoin", symbol: "Ð", color: "from-yellow-400 to-amber-200" },
  { code: "AVZ", name: "AVZ Token", symbol: "A", color: "from-yellow-500 to-amber-400" },
  { code: "LTC", name: "Litecoin", symbol: "Ł", color: "from-slate-400 to-slate-200" },
  { code: "XRP", name: "Ripple", symbol: "●", color: "from-indigo-400 to-indigo-200" },
  { code: "BNB", name: "Binance", symbol: "B", color: "from-yellow-400 to-lime-200" },
  { code: "SOL", name: "Solana", symbol: "S", color: "from-fuchsia-500 to-emerald-300" },
];

// —— card model ——
interface CardModel {
  id: number;
  code: string;
  revealed: boolean;
  matched: boolean;
  lock: boolean;
}

function makeDeck() {
  const base = [...COINS].slice(0, 8); // 8 pairs
  const doubled = [...base, ...base]
    .map((c, i) => ({ id: i + 1, code: c.code, revealed: false, matched: false, lock: false }))
    .sort(() => Math.random() - 0.5);
  return doubled as CardModel[];
}

// —— main component ——
export default function AVZPlayToEarn() {
  // game state
  const [deck, setDeck] = useState<CardModel[]>(makeDeck);
  const [flipped, setFlipped] = useState<number[]>([]);
  const [moves, setMoves] = useState(0);
  const [pairs, setPairs] = useState(0);
  const [running, setRunning] = useState(false);
  const [seconds, setSeconds] = useState(0);

  // economy state
  const [reward, setReward] = useState(0); // available to claim (R$)
  const [balance, setBalance] = useState(100); // R$
  const [tokens, setTokens] = useState(50); // AVZ

  // invest & withdraw
  const [investAmount, setInvestAmount] = useState(1000);
  const [investMonths, setInvestMonths] = useState(6);
  const annualRate = 0.18; // 18% a.a.

  // timer
  useEffect(() => {
    if (!running) return;
    const t = setInterval(() => setSeconds((s) => s + 1), 1000);
    return () => clearInterval(t);
  }, [running]);

  // minute reward (anti-click-spam: only when running and a full minute passes)
  useEffect(() => {
    if (!running || seconds === 0) return;
    if (seconds % 60 === 0) setReward((r) => +(r + 0.05).toFixed(2));
  }, [seconds, running]);

  // derived
  const timeStr = useMemo(() => {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${pad(m)}:${pad(s)}`;
  }, [seconds]);

  // handlers
  const startGame = () => {
    if (running) return;
    setRunning(true);
    setSeconds(0);
    // start bonus
    setReward((r) => +(r + 0.10).toFixed(2));
  };

  const resetGame = () => {
    setRunning(false);
    setSeconds(0);
    setMoves(0);
    setPairs(0);
    setFlipped([]);
    setDeck(makeDeck());
    setReward(0);
  };

  const onFlip = (idx: number) => {
    if (!running) return;
    setDeck((prev) => {
      const d = [...prev];
      const card = d[idx];
      if (card.matched || card.revealed || card.lock) return d;
      card.revealed = true;
      return d;
    });

    setFlipped((curr) => {
      const next = [...curr, idx];
      if (next.length === 2) {
        setMoves((m) => m + 1);
        const [a, b] = next;
        const ca = deck[a];
        const cb = deck[b];
        if (ca && cb && ca.code === cb.code) {
          // match
          setDeck((prev) => {
            const d = prev.map((c, i) => (i === a || i === b ? { ...c, matched: true } : c));
            return d;
          });
          setPairs((p) => p + 1);
          setReward((r) => +(r + 0.25).toFixed(2));
        } else {
          // mismatch → flip back after delay and lock interaction
          setDeck((prev) => {
            const d = prev.map((c, i) => (i === a || i === b ? { ...c, lock: true } : c));
            setTimeout(() => {
              setDeck((prev2) => prev2.map((c, i) => (i === a || i === b ? { ...c, revealed: false, lock: false } : c)));
            }, 700);
            return d;
          });
        }
        // clear buffer
        setTimeout(() => setFlipped([]), 710);
      }
      return next.length === 2 ? next.slice(0, 2) : next;
    });
  };

  // win check
  useEffect(() => {
    if (pairs === 8 && running) {
      // win bonus
      setReward((r) => +(r + 2.0).toFixed(2));
      setRunning(false);
    }
  }, [pairs, running]);

  const claimRewards = () => {
    if (reward <= 0) return;
    setBalance((b) => +(b + reward).toFixed(2));
    setReward(0);
  };

  const investSim = () => {
    const monthlyRate = annualRate / 12;
    const r = monthlyRate * investMonths;
    const earnings = investAmount * r;
    return { earnings, total: investAmount + earnings };
  };

  const connectWallet = () => {
    // placeholder – integrate MetaMask/Snap/WalletConnect aqui
    alert("Conectar carteira: em breve integração com MetaMask/Polygon (AVZ)");
  };

  // —— UI ——
  return (
    <div className="min-h-screen bg-gradient-to-br from-[#0a0a0a] to-zinc-900 text-zinc-50 p-4 md:p-8">
      <div className="mx-auto max-w-6xl">
        {/* Header */}
        <div className="flex flex-col md:flex-row items-center justify-between gap-4 bg-black/40 border border-yellow-600/40 rounded-2xl p-4 md:p-6 shadow-[0_0_30px_-12px_rgba(234,179,8,0.35)]">
          <div className="flex items-center gap-4">
            <div className="size-14 md:size-16 rounded-full bg-gradient-to-br from-yellow-400 to-amber-600 flex items-center justify-center font-black text-xl text-black shadow-[0_0_20px_rgba(234,179,8,0.6)]">AVZ</div>
            <div>
              <h1 className="text-2xl md:text-3xl font-bold tracking-tight bg-gradient-to-r from-yellow-300 via-rose-200 to-yellow-200 bg-clip-text text-transparent">AVZ Play‑to‑Earn</h1>
              <p className="text-sm text-zinc-400">Jogue. Ganhe. Construa seu saldo.</p>
            </div>
          </div>
          <div className="flex flex-wrap items-center gap-3">
            <Badge variant="secondary" className="bg-gradient-to-r from-sky-500 to-indigo-500 text-white px-3 py-2 rounded-xl"><Wallet className="mr-2 h-4 w-4"/>Cliente: <span className="ml-1 font-bold">AVZ‑789456</span></Badge>
            <Badge className="bg-gradient-to-r from-yellow-400 to-amber-600 text-black px-3 py-2 rounded-xl"><CircleDollarSign className="mr-2 h-4 w-4"/>Saldo: <span className="ml-1 font-extrabold">{BRL(balance)}</span></Badge>
            <Badge className="bg-gradient-to-r from-pink-400 to-rose-500 text-white px-3 py-2 rounded-xl"><Coins className="mr-2 h-4 w-4"/>Tokens: <span className="ml-1 font-extrabold">{tokens}</span></Badge>
            <Button variant="secondary" onClick={connectWallet} className="rounded-2xl"><Rocket className="mr-2 h-4 w-4"/>Conectar carteira</Button>
          </div>
        </div>

        {/* TABS */}
        <Tabs defaultValue="game" className="mt-6">
          <TabsList className="grid grid-cols-3 md:w-[520px]">
            <TabsTrigger value="game"><Trophy className="mr-2 h-4 w-4"/>Jogo</TabsTrigger>
            <TabsTrigger value="invest"><TrendingUp className="mr-2 h-4 w-4"/>Investir</TabsTrigger>
            <TabsTrigger value="withdraw"><Banknote className="mr-2 h-4 w-4"/>Resgatar</TabsTrigger>
          </TabsList>

          {/* GAME TAB */}
          <TabsContent value="game" className="mt-6">
            <div className="grid md:grid-cols-3 gap-6">
              {/* board */}
              <Card className="md:col-span-2 bg-black/40 border-yellow-600/30">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">Jogo da Memória Cripto <Sparkles className="h-5 w-5 text-yellow-400"/></CardTitle>
                  <CardDescription>Encontre os 8 pares para ganhar bônus.</CardDescription>
                </CardHeader>
                <CardContent>
                  {/* info bar */}
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <InfoPill label="Tentativas" value={String(moves)} />
                    <InfoPill label="Pares" value={`${pairs}/8`} />
                    <InfoPill label="Tempo" value={timeStr} />
                    <InfoPill label="Prêmio" value={BRL(reward)} highlight />
                  </div>

                  {/* grid */}
                  <div className="grid grid-cols-4 gap-3 md:gap-4">
                    {deck.map((c, idx) => (
                      <Tile key={c.id} code={c.code} revealed={c.revealed || c.matched} locked={c.lock} onClick={() => onFlip(idx)} />
                    ))}
                  </div>

                  <div className="flex items-center justify-center gap-3 mt-5">
                    <Button onClick={startGame} className="rounded-2xl"><Play className="mr-2 h-4 w-4"/>Começar</Button>
                    <Button variant="secondary" onClick={resetGame} className="rounded-2xl"><Repeat className="mr-2 h-4 w-4"/>Reiniciar</Button>
                    <Button variant="outline" onClick={claimRewards} className="rounded-2xl border-yellow-500/50 text-yellow-300"><Gift className="mr-2 h-4 w-4"/>Resgatar</Button>
                  </div>
                </CardContent>
                <CardFooter className="justify-center">
                  <Progress value={(pairs / 8) * 100} className="h-2" />
                </CardFooter>
              </Card>

              {/* rewards side */}
              <Card className="bg-black/40 border-rose-500/30">
                <CardHeader>
                  <CardTitle>Recompensas</CardTitle>
                  <CardDescription>Como você ganha no jogo</CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  <RewardRow title="Por jogo iniciado" value={BRL(0.10)} />
                  <RewardRow title="Por par encontrado" value={BRL(0.25)} />
                  <RewardRow title="Bônus de vitória" value={BRL(2.00)} />
                  <Separator className="my-4" />
                  <div className="rounded-xl border border-rose-400/30 p-3 bg-rose-500/10">
                    <p className="text-sm text-rose-200">Anti‑fraude: ganhos por minuto apenas com jogo em andamento.</p>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* INVEST TAB */}
          <TabsContent value="invest" className="mt-6">
            <Card className="bg-black/40 border-yellow-600/30">
              <CardHeader>
                <CardTitle>Investimento AVZ</CardTitle>
                <CardDescription>1 AVZ = R$ 1,00 • Retorno alvo {Math.round(annualRate*100)}% a.a. (proporcional)</CardDescription>
              </CardHeader>
              <CardContent className="grid md:grid-cols-3 gap-6">
                <div className="md:col-span-2 space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="amount">Valor do investimento (R$)</Label>
                      <Input id="amount" type="number" min={100} value={investAmount}
                        onChange={(e) => setInvestAmount(Number(e.target.value))} />
                    </div>
                    <div>
                      <Label>Tempo (meses)</Label>
                      <Select value={String(investMonths)} onValueChange={(v) => setInvestMonths(Number(v))}>
                        <SelectTrigger className="w-full"><SelectValue placeholder="6"/></SelectTrigger>
                        <SelectContent>
                          {[1,3,6,9,12].map(m => <SelectItem key={m} value={String(m)}>{m}</SelectItem>)}
                        </SelectContent>
                      </Select>
                    </div>
                  </div>

                  <div className="rounded-xl border border-yellow-500/30 p-4 bg-yellow-500/10">
                    {(() => {
                      const { earnings, total } = investSim();
                      return (
                        <div className="space-y-1">
                          <p>Rendimento estimado: <span className="font-semibold text-yellow-300">{BRL(earnings)}</span></p>
                          <p>Total ao final: <span className="font-semibold text-yellow-300">{BRL(total)}</span></p>
                        </div>
                      );
                    })()}
                  </div>

                  <div className="text-xs text-zinc-400 flex items-center gap-2"><ShieldCheck className="h-4 w-4"/>Simulação informativa. Não é promessa de rendimento. Sujeita a riscos de mercado e tributos.</div>
                </div>

                <div className="space-y-3">
                  <div className="rounded-xl border border-emerald-500/30 p-4 bg-emerald-500/10">
                    <p className="text-sm">Bônus: a cada R$ 10 simulados você ganha 1 AVZ de teste.</p>
                    <Dialog>
                      <DialogTrigger asChild>
                        <Button className="mt-3 rounded-2xl"><Gift className="mr-2 h-4 w-4"/>Aplicar bônus</Button>
                      </DialogTrigger>
                      <DialogContent>
                        <DialogHeader>
                          <DialogTitle>Aplicar bônus de tokens</DialogTitle>
                        </DialogHeader>
                        <p className="text-sm text-zinc-500">Isto adiciona tokens de demonstração à sua conta.</p>
                        <DialogFooter>
                          <Button onClick={() => setTokens((t) => t + Math.floor(investAmount / 10))} className="rounded-2xl">Adicionar AVZ</Button>
                        </DialogFooter>
                      </DialogContent>
                    </Dialog>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* WITHDRAW TAB */}
          <TabsContent value="withdraw" className="mt-6">
            <Card className="bg-black/40 border-yellow-600/30">
              <CardHeader>
                <CardTitle>Resgate de Saldo</CardTitle>
                <CardDescription>Transferência via conta bancária</CardDescription>
              </CardHeader>
              <CardContent className="grid md:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <div>
                    <Label htmlFor="w-amount">Valor para resgate (mín. R$ 10,00)</Label>
                    <Input id="w-amount" type="number" min={10} placeholder="100" />
                  </div>
                  <div>
                    <Label>Conta bancária</Label>
                    <Select defaultValue="itau">
                      <SelectTrigger className="w-full"><SelectValue /></SelectTrigger>
                      <SelectContent>
                        <SelectItem value="itau">Itaú – ****1234</SelectItem>
                        <SelectItem value="bradesco">Bradesco – ****5678</SelectItem>
                        <SelectItem value="santander">Santander – ****9012</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label htmlFor="w-pass">Senha de confirmação</Label>
                    <Input id="w-pass" type="password" placeholder="••••••" />
                  </div>
                </div>
                <div className="space-y-3">
                  <div className="rounded-xl border border-rose-500/30 p-4 bg-rose-500/10">
                    <p className="text-sm">O saldo disponível é {BRL(balance)}. Solicitações são processadas em até 2 dias úteis.</p>
                  </div>
                  <Button className="rounded-2xl"><Banknote className="mr-2 h-4 w-4"/>Solicitar resgate</Button>
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>

        {/* Footer */}
        <div className="mt-8 text-center text-xs text-zinc-500">
          © {new Date().getFullYear()} AVZ PropTech • Play‑to‑Earn demo UI
        </div>
      </div>
    </div>
  );
}

// —— small components ——
function InfoPill({ label, value, highlight }: { label: string; value: string; highlight?: boolean }) {
  return (
    <div className={`rounded-2xl p-3 border \n      ${highlight ? "border-yellow-500/60 bg-yellow-500/10" : "border-zinc-700 bg-zinc-800/40"}`}>
      <div className="text-xs text-zinc-400">{label}</div>
      <div className="text-lg font-semibold tracking-tight">{value}</div>
    </div>
  );
}

function Tile({ code, revealed, locked, onClick }: { code: string; revealed: boolean; locked: boolean; onClick: () => void }) {
  const coin = COINS.find((c) => c.code === code)!;
  return (
    <button
      onClick={onClick}
      disabled={revealed || locked}
      className={`relative aspect-square rounded-2xl border overflow-hidden select-none \n        ${revealed ? "border-emerald-400/60" : "border-zinc-700 hover:border-zinc-500"} \n        transition-all duration-300 group`}
    >
      <div className={`absolute inset-0 bg-gradient-to-br ${coin.color} ${revealed ? "opacity-100" : "opacity-0 group-hover:opacity-80"} transition-opacity`} />
      <div className="relative z-10 h-full w-full flex flex-col items-center justify-center gap-1">
        <div className={`text-3xl md:text-4xl ${revealed ? "text-black" : "text-zinc-200"}`}>{coin.symbol}</div>
        <div className={`text-[10px] md:text-xs font-semibold tracking-wider ${revealed ? "text-black/80" : "text-zinc-400"}`}>{coin.code}</div>
      </div>
    </button>
  );
}

function RewardRow({ title, value }: { title: string; value: string }) {
  return (
    <div className="flex items-center justify-between rounded-xl border border-rose-400/30 bg-rose-500/10 px-3 py-2">
      <div className="text-sm">{title}</div>
      <div className="text-sm font-semibold text-rose-200">{value}</div>
    </div>
  );
}
