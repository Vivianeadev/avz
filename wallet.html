<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AVZ PropTech - Carteira & Proje√ß√£o de Valor</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --black:#0a0a0a; --dark-black:#000; --gold:#d4af37; --light-gold:#f4e4bc;
  --rose-gold:#e8b4b8; --dark-rose:#c49497; --white:#fff; --light-gray:#f8f8f8;
  --medium-gray:#888; --dark-gray:#333;
}
body {
  font-family:'Inter',sans-serif;
  background:linear-gradient(135deg,var(--dark-black)0%,var(--black)25%,#1a1a1a 50%,var(--black)75%,var(--dark-black)100%);
  background-attachment:fixed;
  min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  padding:20px 0; position:relative;
}
body::before {
  content:''; position:fixed; top:0; left:0; width:100%; height:100%;
  background: radial-gradient(circle at 20% 20%, rgba(212,175,55,0.05)0%,transparent 50%),
             radial-gradient(circle at 80% 80%, rgba(232,180,184,0.05)0%,transparent 50%),
             radial-gradient(circle at 40% 60%, rgba(212,175,55,0.03)0%,transparent 50%);
  pointer-events:none; z-index:-1;
}
.container {
  background: linear-gradient(145deg, rgba(255,255,255,0.08)0%,rgba(255,255,255,0.02)100%);
  backdrop-filter: blur(25px); border:2px solid transparent; background-clip:padding-box;
  position:relative; border-radius:24px; padding:50px 40px; text-align:center; max-width:650px; width:90%;
  margin-bottom:30px; box-shadow:0 32px 64px rgba(0,0,0,0.4),0 0 0 1px rgba(212,175,55,0.2),inset 0 1px 0 rgba(255,255,255,0.1);
}
h1 {
  font-family:'Playfair Display',serif;
  background: linear-gradient(135deg, var(--gold)0%,var(--light-gold)50%,var(--rose-gold)100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-size:2.8rem; font-weight:700; margin-bottom:25px;
}
h2 { font-family:'Playfair Display',serif; font-size:2rem; margin-bottom:15px; }
p { color: rgba(255,255,255,0.9); font-size:1.2rem; margin-bottom:25px; }
.loading { font-size:1.2rem; color:#f4e4bc; }
.error { color:red; }
.token-item { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; margin:6px 0;
  background:rgba(255,255,255,0.05); border-radius:10px; border:1px solid rgba(255,255,255,0.1); transition:background 0.3s; }
.token-item:hover { background:rgba(255,255,255,0.1); }
.token-info { display:flex; flex-direction:column; text-align:left; }
.token-symbol { font-size:1.2rem; font-weight:600; color:var(--gold); }
.token-name { font-size:0.9rem; color:var(--medium-gray); }
.token-balance { text-align:right; }
.token-amount { font-size:1.1rem; font-weight:600; color:#fff; }
.token-item.zero-balance .token-amount { color:#888; }
.home-button { margin-top:25px; padding:12px 25px; background:linear-gradient(135deg,var(--gold),var(--rose-gold));
  color:#000; font-weight:600; border:none; border-radius:12px; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s; }
.home-button:hover { transform:translateY(-2px); box-shadow:0 4px 15px rgba(212,175,55,0.4); }
.projection-currency { font-size:0.8rem; color:var(--medium-gray); margin-left:5px; }
</style>
</head>
<body>
<div class="container">
  <h1>AVZ PropTech - Acesso √† Web3</h1>
  <p>Digite o endere√ßo da carteira para consultar os tokens e saldo MATIC.</p>
  <input type="text" id="walletAddress" placeholder="Endere√ßo da carteira" style="padding:10px;width:80%;border-radius:5px;border:1px solid #ccc;">
  <button id="lookupBtn" onclick="lookupWallet()" style="margin-top:15px;padding:10px 20px;background-color:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;">Consultar</button>
  <div id="nativeBalance" class="loading">Carregando saldo MATIC...</div>
  <div id="tokensList" class="tokens-title">Tokens ERC-20 (0)</div>
  <div id="tokensMessage" class="loading"></div>
</div>

<!-- Proje√ß√£o de Valor -->
<div class="container" id="projection">
  <h2 style="background:linear-gradient(135deg,var(--gold),var(--rose-gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üìä Proje√ß√£o de Valor</h2>
  <p style="color:#ccc; font-size:1rem; margin-bottom:20px;">Valores estimados em v√°rias moedas. Podem variar a qualquer momento.</p>
  <div id="projectionData" style="color:#fff; font-size:1.2rem;">Carregando proje√ß√£o de valores...</div>
</div>

<button class="home-button" onclick="window.location.href='index.html'">üè† Retornar ao Home</button>

<script>
let provider = new ethers.providers.JsonRpcProvider('https://polygon-rpc.com');
let currentAddress = '';
let tokens = [];
let isLookingUp = false;

const popularPolygonTokens = [
  { address:'0xcE20F7cb738aA5Cf32441B2ba0EFBA1E6f42c0b4', symbol:'AVZ', name:'AVZ', decimals:18 },
  { address:'0x2EfADD20B18E551d97994790D217915e56005b4f', symbol:'AV9', name:'AV9', decimals:18 }
];

function isValidAddress(address){ return ethers.utils.isAddress(address); }

async function lookupWallet() {
  if(isLookingUp) return;
  const addressInput = document.getElementById('walletAddress');
  const address = addressInput.value.trim();
  if(!address){ alert('Insira um endere√ßo de carteira.'); return; }
  if(!isValidAddress(address)){ alert('Endere√ßo Ethereum inv√°lido.'); return; }
  isLookingUp = true;
  const lookupBtn = document.getElementById('lookupBtn');
  const originalText = lookupBtn.textContent;
  lookupBtn.textContent='Consultando...'; lookupBtn.disabled=true;
  try{
    currentAddress=address;
    await updateWalletInfo();
    await fetchAllTokensIncludingZero();
    await fetchProjection();
  }catch(err){ alert("Erro ao consultar carteira: "+err.message); }
  finally{ isLookingUp=false; lookupBtn.textContent=originalText; lookupBtn.disabled=false; }
}

async function updateWalletInfo(){
  if(!provider||!currentAddress) return;
  try{
    document.getElementById('nativeBalance').textContent='Carregando saldo MATIC...';
    const balance = await provider.getBalance(currentAddress);
    const balanceInMatic = ethers.utils.formatEther(balance);
    document.getElementById('nativeBalance').textContent = `${parseFloat(balanceInMatic).toFixed(4)} MATIC`;
  }catch(err){ document.getElementById('nativeBalance').textContent='Erro ao carregar saldo'; }
}

async function fetchAllTokensIncludingZero(){
  if(!currentAddress) return;
  try{
    document.getElementById('tokensMessage').textContent='Buscando tokens...';
    let discoveredTokens = new Map();
    const polygonscanApiKey = 'YourApiKeyToken';
    const response = await fetch(`https://api.polygonscan.com/api?module=account&action=tokentx&address=${currentAddress}&startblock=0&endblock=999999999&sort=asc&apikey=${polygonscanApiKey}`);
    if(response.ok){
      const data = await response.json();
      if(data.status==='1' && data.result){
        data.result.forEach(tx=>{
          if(tx.contractAddress && tx.tokenSymbol && tx.tokenName){
            discoveredTokens.set(tx.contractAddress.toLowerCase(),{
              address:tx.contractAddress,
              symbol:tx.tokenSymbol,
              name:tx.tokenName,
              decimals:parseInt(tx.tokenDecimal)||18
            });
          }
        });
      }
    }
    popularPolygonTokens.forEach(token=>{
      if(!discoveredTokens.has(token.address.toLowerCase())) discoveredTokens.set(token.address.toLowerCase(),token);
    });
    const allTokens = Array.from(discoveredTokens.values());
    tokens=[];
    for(let token of allTokens){
      try{
        const contract = new ethers.Contract(token.address,['function balanceOf(address) view returns (uint256)'],provider);
        const balance = await contract.balanceOf(currentAddress);
        const balanceFormatted = ethers.utils.formatUnits(balance,token.decimals);
        tokens.push({...token,balance,balanceFormatted,balanceNumber:parseFloat(balanceFormatted)});
      }catch(e){ tokens.push({...token,balance:0,balanceFormatted:'0',balanceNumber:0}); }
    }
    const uniqueTokens=[];
    const seen=new Set();
    tokens.forEach(token=>{ if(!seen.has(token.symbol)){ seen.add(token.symbol); uniqueTokens.push(token); } });
    tokens=uniqueTokens;
    tokens.sort((a,b)=>{
      if(a.balanceNumber>0 && b.balanceNumber===0) return -1;
      if(a.balanceNumber===0 && b.balanceNumber>0) return 1;
      return a.symbol.localeCompare(b.symbol);
    });
    updateTokensList();
  }catch(err){ document.getElementById('tokensMessage').textContent='Erro ao carregar tokens'; }
}

function updateTokensList(){
  const tokensListDiv = document.getElementById('tokensList');
  const tokensTitle = document.querySelector('.tokens-title');
  if(tokens.length===0){ tokensListDiv.innerHTML=''; tokensTitle.textContent='Tokens ERC-20 (0)';
    document.getElementById('tokensMessage').textContent='Insira um endere√ßo para consultar todos os tokens.'; return; }
  tokensTitle.textContent=`Tokens ERC-20 (${tokens.length})`; document.getElementById('tokensMessage').textContent='';
  let html = tokens.map(token=>`
    <div class="token-item ${token.balanceNumber===0?'zero-balance':''}">
      <div class="token-info">
        <div class="token-symbol">${token.symbol}</div>
        <div class="token-name">${token.name}</div>
      </div>
      <div class="token-balance">
        <div class="token-amount">${parseFloat(token.balanceFormatted).toFixed(6)}</div>
      </div>
    </div>
  `).join('');
  tokensListDiv.innerHTML=html;
}

async function fetchProjection(){
  if(!currentAddress) return;
  try{
    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=matic-network,tether&vs_currencies=usd,brl,eur,gbp');
    if(!response.ok) throw new Error('Erro ao buscar pre√ßos');
    const prices = await response.json();

    let projectionHTML='';
    const maticToken = tokens.find(t=>t.symbol==='MATIC');
    const maticAmount = maticToken ? maticToken.balanceNumber : 0;
    const otherTokens = tokens.filter(t=>t.symbol!=='MATIC');

    // Fun√ß√£o de formata√ß√£o para m√∫ltiplas moedas
    const formatCurrencies = (amountUSD)=>{
      const usd = amountUSD;
      const brl = amountUSD * prices['matic-network'].brl/prices['matic-network'].usd;
      const eur = amountUSD * prices['matic-network'].eur/prices['matic-network'].usd;
      const gbp = amountUSD * prices['matic-network'].gbp/prices['matic-network'].usd;
      return `US$ ${usd.toFixed(2)} <span class="projection-currency">R$ ${brl.toFixed(2)} | ‚Ç¨ ${eur.toFixed(2)} | ¬£ ${gbp.toFixed(2)}</span>`;
    };

    // MATIC
    const maticUSD = maticAmount * prices['matic-network'].usd;
    projectionHTML+=`<div class="token-item">
      <div class="token-info"><div class="token-symbol">MATIC</div><div class="token-name">Polygon</div></div>
      <div class="token-balance"><div class="token-amount">${formatCurrencies(maticUSD)}</div></div>
    </div>`;

    // Outros tokens (aproximando com USDT como base)
    otherTokens.forEach(token=>{
      const usd = token.balanceNumber * prices['tether'].usd;
      projectionHTML+=`<div class="token-item">
        <div class="token-info"><div class="token-symbol">${token.symbol}</div><div class="token-name">${token.name}</div></div>
        <div class="token-balance"><div class="token-amount">${formatCurrencies(usd)}</div></div>
      </div>`;
    });

    document.getElementById('projectionData').innerHTML=projectionHTML;
  }catch(err){
    document.getElementById('projectionData').textContent='N√£o foi poss√≠vel carregar proje√ß√£o de valor';
  }
}

function goHome(){ window.location.href='/'; }
setInterval(fetchProjection,60000);
</script>
</body>
</html>
